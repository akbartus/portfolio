<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Voice Controlled Interactive 360 Video</title>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="aframe-htmlembed-component.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="intropage">
    <!-- Welcome sentence -->
    <div id="welcome">
      <p>Welcome to sound controlled interactive 360 video experience! <br />
        Please click on "Start" to activate speech recognition.</p>
    </div>
    <!-- On Button cLick activate web camera with ML -->
    <p id="mybutton"><button id="intro" type="button" onclick="runSpeechRecognition(); closeIntroPage();">Start</button>
      &nbsp; <span id="action"></span></p>
  </div>

  <a-scene cursor="rayOrigin: mouse" vr-mode-ui="enabled: true" loading-screen="dotsColor: white; backgroundColor: black">
    <a-assets>
      <video id="vid" autoplay src=""></video>
    </a-assets>
    <a-camera id="camera"></a-camera>
    <a-entity id="test" htmlembed position="0 1 -1" rotation="0 0 0" scale="0.8 0.8 0.8">

      <div class="speechToText">
        <div id="word"></div>
      </div>
    </a-entity>
    <a-videosphere src="#vid" rotation="0 0 0"></a-videosphere>

  </a-scene>
  <script>
    // get output div reference
    var output = document.getElementById("word");
    var recognizedHello = 0;
    var recognizedAkbar = 0;
    var recognizedBrother = 0;
    // get action element reference
    var action = document.getElementById("action");
    /* Speech to Text Script */
    function runSpeechRecognition() {
      // new speech recognition object
      var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
      var recognition = new SpeechRecognition();

      // This runs when the speech recognition service starts
      recognition.onstart = function () {
        action.innerHTML = "<small>Please speak...</small>";
      };

      /* 
      recognition.onspeechend = function () {
        action.innerHTML = "";
        recognition.stop();
      }
      */
      // After recognition's end, restart it, so that to create a loop 
      recognition.onend = function () {
        recognition.start();
      };

      // This runs when the speech recognition service returns result
      recognition.onresult = function (event) {
        var transcript = event.results[0][0].transcript;
        var confidence = event.results[0][0].confidence;
        // Put recognized speech text into output variable
        output.innerHTML = transcript;


        // If phrase is recognized, go to branch 1, "Hello"
        if (output.innerHTML.indexOf("hello") !== -1) {
          // change background color of the recognized text to show that it was successful
          recognizedHello++;
          if (recognizedHello == 1) correctWord();
        }
        if (output.innerHTML.toLowerCase().indexOf("akbar") !== -1) {
          // change background color of the recognized text to show that it was successful
          recognizedAkbar++;
          if (recognizedAkbar == 1) correctWord();
        }
        if (output.innerHTML.indexOf("brother") !== -1) {
          // change background color of the recognized text to show that it was successful
          recognizedBrother++;
          if (recognizedBrother == 1) correctWord();
        }

      }
      // start recognition

      recognition.start();
    }

    function correctWord() {
      output.style.background = "#037b1a";

      // hide after 3 seconds the text and clean the background of recognition text
      setTimeout(function () {
        output.innerHTML = "";
        output.style.background = "#000000";
      }, 3000);

      if (recognizedAkbar > 0 && recognizedBrother > 0 && recognizedHello > 0)
        recognizedVideo();
    }

    function recognizedVideo() {

      // wait until the video ends and load the given one.
      let videobranch1 = document.getElementById('vid');
      videobranch1.addEventListener('ended', function (evt) {
        console.log("this is end of the video")
        videobranch1.setAttribute('src', "video2.mp4");
      });
    }

    // Hide Intro Page Overlay
    function closeIntroPage() {
      document.getElementById("vid").setAttribute("src", "video1.mp4");
      document.getElementById("intropage").style.display = "none";

    }
  </script>
</body>

</html>